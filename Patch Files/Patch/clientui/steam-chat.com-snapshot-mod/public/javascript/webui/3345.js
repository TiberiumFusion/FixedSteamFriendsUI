










/**** (c) Valve Corporation. Use is governed by the terms of the Steam Subscriber Agreement http://store.steampowered.com/subscriber_agreement/. 
****/
"use strict";(self.webpackChunk_steam_friendsui=self.webpackChunk_steam_friendsui||[]).push([[3345],{68270:(e,t,i)=>{i.d(t,{ZI:()=>l,fX:()=>m,q_:()=>r,tG:()=>o,tH:()=>s,xv:()=>d});const n=new(i(35946).wd)("GR");function a(e){return(...t)=>{const i=`[${(performance.now()/1e3).toFixed(3)}]`;e(i,...t)}}const r=a(n.Debug),m=a(n.Info),s=a(n.Warning),l=a(n.Error),o=r;function d(){return n.IsDebugEnabled()}},63236:(e,t,i)=>{var n,a;function r(e){return"gamemode"===e.type}function m(e){return"state_description"===e.type}function s(e){return"event"===e.type&&parseInt(e.duration)>0}function l(e){return"event"===e.type}function o(e){return"achievement"===e.type}function d(e){return"error"===e.type}function _(e){return"usermarker"===e.type}function f(e){return"screenshot"===e.type}function u(e){let t={id:e.entry_id,time:e.time,type:void 0};switch(e.type){case 1:{let i=t;i.type="gamemode",i.mode=e.game_mode;break}case 5:{let i=t;i.type="usermarker",i.icon="steam_marker",i.priority=e.marker_priority;break}case 4:{let i=t;i.type="achievement",i.achievement_name=e.achievement_name;break}case 7:{let i=t;i.type="error",i.description=e.marker_description;break}case 3:{let i=t;i.type="state_description",i.title=e.timestamp_title;break}case 2:{let i=t;i.type="event",i.icon=e.marker_icon,i.title=e.range_title,i.description=e.marker_description,i.priority=e.marker_priority,i.duration=e.range_duration,i.possible_clip=e.range_possible_clip;break}case 6:{let i=t;i.type="screenshot",i.icon=e.marker_icon,i.priority=e.marker_priority,i.handle=e.screenshot_handle;break}default:return null}return t}i.d(t,{In:()=>d,N$:()=>_,Te:()=>m,eJ:()=>l,hT:()=>r,il:()=>n,rU:()=>u,sX:()=>f,xz:()=>o,zG:()=>s}),function(e){e[e.Invalid=0]="Invalid",e[e.Playing=1]="Playing",e[e.Staging=2]="Staging",e[e.Menus=3]="Menus"}(n||(n={})),function(e){e[e.Invalid=0]="Invalid",e[e.None=1]="None",e[e.Standard=2]="Standard",e[e.Featured=3]="Featured"}(a||(a={}))},69502:(e,t,i)=>{function n(e){return{type:"global",valMS:e}}function a(e){return{type:"timeline",valMS:e}}function r(e){return t=>t.type===e}i.d(t,{OB:()=>m,QP:()=>s,Sb:()=>n,sK:()=>a});r("global"),r("timeline"),r("recording"),r("clip");function m(e){return{type:"global",valPX:e}}function s(e){return{type:"scrollWindow",valPX:e}}function l(e){return t=>t.type===e}l("global"),l("clientWindow"),l("virtualWindow"),l("scrollWindow")},53345:(e,t,i)=>{i.d(t,{SX:()=>S,kh:()=>T});var n=i(34629),a=i(83957),r=i.n(a),m=i(35586),s=i(54733),l=i(68270),o=i(63236),d=i(60339),_=i(63680),f=i(3539),u=i(69502),c=(i(63696),i(89193)),g=i(79098),h=i(16518),p=i(16081);const T=3e3,I=T+1e3;class S{constructor(){(0,c.Gn)(this)}m_bInitialized=!1;m_rgListeners=[];m_gameID;m_clipID;m_ulFirstTimelineOffsetMS=0;m_rgTimelineMetadata=[];m_mapTimelineData=new Map;m_mapRunningTimelines=new Map;m_schUpdateRunning=new _.LU;m_fnTimelineURLBuilder;BInitialized(){return this.m_bInitialized}GetTimelines(){return this.m_rgTimelineMetadata}GetTimelineMetadataIndex(e){return this.m_rgTimelineMetadata.findIndex((t=>t.metadata.timeline_id===e))}GetTimelineMetadata(e){return this.m_rgTimelineMetadata.find((t=>t.metadata.timeline_id===e))}GetGameID(){return this.m_gameID}GetClipID(){return this.m_clipID}BIsTimelineRunning(e){return this.m_mapRunningTimelines.has(e)}AddEventListener(e){return this.m_rgListeners.push(e),()=>s.x9(this.m_rgListeners,e)}async LoadTimelinesForBackgroundVideo(e){this.m_gameID=e;const t=await m.xM.GetTimelinesForApp({game_id:e}),{timelines:i=[]}=t.Body().toObject();this.m_mapRunningTimelines.forEach(((e,t)=>{i.find((e=>e.timeline_id==t))||i.push(e.m_metadata)})),this.UpdateTimelineMetadata(i),this.m_fnTimelineURLBuilder=e=>`https://steamloopback.host/gamerecordings/timelines/${e}.json`,this.m_bInitialized=!0,this.FireEvent("OnLoaderInitialized")}async LoadTimelinesForClip(e){this.m_clipID=e;const t=await m.xM.GetTimelinesForClip({clip_id:e});if(1!=t.GetEResult())throw new Error("Unable to load clip "+e);const{timelines:i=[],game_id:n,first_timeline_start_offset_ms:a}=t.Body().toObject();this.m_gameID=n,this.UpdateTimelineMetadata(i);for(let t of this.m_rgTimelineMetadata){(0,l.q_)(`Loaded clip ${e} timeline ${t.metadata.timeline_id}`);for(let e of t.metadata.recordings)(0,l.q_)(`Clip recording ${e.recording_id} duration ${e.duration_ms}`)}this.m_ulFirstTimelineOffsetMS=parseInt(a),this.m_fnTimelineURLBuilder=e=>`https://steamloopback.host/gamerecordings/clips/${this.m_clipID}/timelines/${e}.json`,this.m_bInitialized=!0,this.FireEvent("OnLoaderInitialized")}UpdateTimelineMetadata(e){const t=e.slice().sort(((e,t)=>e.date_recorded-t.date_recorded));let i=[],n=0;const a={};t.forEach((t=>{t.recordings||(t.recordings=[]),a[t.timeline_id]?console.error("Duplicate timelines found in UpdateTimelineMetadata()",t.timeline_id,e):(i.push({nGlobalOffsetMS:(0,u.Sb)(n),metadata:t}),n+=parseInt(t.duration_ms),a[t.timeline_id]=!0)})),this.m_rgTimelineMetadata=i}LoadTimelinesForSharedClip(e){this.SetPreloadedTimelines(0,e.clip_id,e.game_id,e.timelines,void 0)}LoadTimelinesForTestGame(e,t){this.SetPreloadedTimelines(0,void 0,e,t,(e=>`https://steamloopback.host/gamerecordings/timelines/${e}.json`))}LoadTimelinesForTestClip(e,t,i,n){this.SetPreloadedTimelines(e,t,i,n,void 0)}SetPreloadedTimelines(e,t,i,n,a){this.m_gameID=i,this.m_clipID=t,this.m_ulFirstTimelineOffsetMS=e;const r=n.slice();this.m_mapRunningTimelines.forEach(((e,t)=>{r.find((e=>e.timeline_id==t))||r.push(e.m_metadata)})),this.UpdateTimelineMetadata(r),this.m_fnTimelineURLBuilder=a,this.m_bInitialized=!0,this.FireEvent("OnLoaderInitialized")}FireEvent(e,...t){for(let i of this.m_rgListeners){let n=i[e];n instanceof Function&&n.apply(i,t)}}async LoadTimelineData(e){let t=this.m_mapTimelineData.get(e);if(t&&"loading"===t.m_strState)return void await t.m_promise;if(t&&"error"==t.m_strState)return;if(this.IsActiveTimeline(e)&&"loaded"==t.m_strState)return;const i={m_rgGameModeChanges:[],m_rgStateDescriptions:[],m_rgEntries:[],m_rgPhases:[]};if(this.m_fnTimelineURLBuilder){const t=this.m_fnTimelineURLBuilder(e),n=r().get(t,{withCredentials:!1}).then((t=>{if(200==t.status&&t.data){const i=this.ProcessTimelineEntries(t.data);this.m_mapTimelineData.set(e,i)}else this.m_mapTimelineData.set(e,{...i,m_strState:"error"})}),(t=>{this.m_mapTimelineData.set(e,{...i,m_strState:"error"})})).finally((()=>this.FireEvent("OnTimelineLoaded",e)));this.m_mapTimelineData.set(e,{m_strState:"loading",m_promise:n,...i})}else this.m_mapTimelineData.set(e,{m_strState:"loaded",...i})}ProcessTimelineEntries(e){let t={m_strState:"loaded",m_rgGameModeChanges:[],m_rgStateDescriptions:[],m_rgEntries:[],m_rgPhases:[]};if(e.entries){const i=[],n=[],a=[],r=[];for(const t of e.entries)switch(t.type){case"phase":a.push(t);break;case"gamemode":i.push(t);break;case"state_description":n.push(t);break;case"achievement":case"error":case"event":case"screenshot":case"usermarker":r.push(t);break;default:console.error(`Unknown timeline entry type ${t.type}`)}const m=(e,t)=>parseInt(e.time)-parseInt(t.time);t.m_rgGameModeChanges=i.sort(m),t.m_rgStateDescriptions=n.sort(m),t.m_rgPhases=a.sort(m),t.m_rgEntries=r.sort(m),t.m_rgGameModeChanges.length>0&&parseInt(t.m_rgGameModeChanges[0].time)<1e4&&(t.m_rgGameModeChanges[0].time="0")}return t}static ApplyTimelineRounding(e,t){if(0===t)return e;const i=e%t;return 0==i?e:e+(t-i)}FindTimelineAtOffset(e,t){const i=e+this.m_ulFirstTimelineOffsetMS;let n=0;for(let e of this.m_rgTimelineMetadata){const a=this.GetTimelineStartBeforeGlobalZeroMS(e.metadata.timeline_id);let r=parseInt(e.metadata.duration_ms)+a;if(n+r>i)return{timeline:e,nTimelineOffsetMS:i-n,ulGlobalToTimelineOffset:a};n+=S.ApplyTimelineRounding(r,t)}return null}GetGlobalOffsetDataForTimeline(e,t){let i=0;for(let n of this.m_rgTimelineMetadata){let a=parseInt(n.metadata.duration_ms),r=S.ApplyTimelineRounding(a,t);if(n.metadata.timeline_id==e)return{nGlobalOffsetMS:i,nRoundedDurationMS:r};i+=r}return null}CreateGlobalRangeForTimeline(e,t,i,n){let a=t-i,r=t+n;return this.ClampGlobalRangeToTimeline(e,a,r)}ClampGlobalRangeToTimeline(e,t,i){let n=this.GetGlobalOffsetDataForTimeline(e,0);return n?[Math.max(t,n.nGlobalOffsetMS),Math.min(i,n.nGlobalOffsetMS+n.nRoundedDurationMS-1)]:[0,0]}GetTimelineOffsetFromGlobal(e,t){const i=this.m_ulFirstTimelineOffsetMS+e;let n=0;for(let e of this.m_rgTimelineMetadata){const a=this.GetTimelineStartBeforeGlobalZeroMS(e.metadata.timeline_id),r=parseInt(e.metadata.duration_ms)+a;if(i<n+S.ApplyTimelineRounding(r,t))return{strTimelineID:e.metadata.timeline_id,nTimelineOffsetMS:(0,u.sK)(i-n-a)};n+=r}return{strTimelineID:void 0,nTimelineOffsetMS:(0,u.sK)(NaN)}}ConvertRecordingOffsetToGlobalOffset(e,t,i){let n=0;for(let a of this.m_rgTimelineMetadata){let r=parseInt(a.metadata.duration_ms);const m=this.GetTimelineStartBeforeGlobalZeroMS(a.metadata.timeline_id);let s=S.ApplyTimelineRounding(r,i);for(let i of a.metadata.recordings)if(i.recording_id===e){let e=(isNaN(parseInt(i.recording_zero_timeline_offset_ms))?0:parseInt(i.recording_zero_timeline_offset_ms)-m)+t;return n+=e,{nGlobalOffsetMS:n,nRoundedDurationMS:s,strTimelineID:a.metadata.timeline_id,nTimelineOffsetMS:e}}n+=s}return null}IsActiveTimeline(e){return!!e&&this.m_mapRunningTimelines.has(e)}MakeRelativeToTimelineEndIfActive(e,t){if(!this.IsActiveTimeline(e))return t;const i=this.GetTimelineMetadata(e);if(!i)return t;let n=parseInt(i.metadata.duration_ms);return Math.min(t-n,0)}IsActiveRecording(e){for(let t of this.m_rgTimelineMetadata)for(let i of t.metadata.recordings)if(i.recording_id===e){const i=this.m_mapRunningTimelines.get(t.metadata.timeline_id);return!(!i||!i.m_runningRecording)&&i.m_runningRecording.recording_id===e}return!1}GetRunningTimelineDurationMS(e){let t=this.m_mapRunningTimelines.get(e);if(!t)return 0;let i=performance.now()-t.m_perfCounterStart+t.m_nPerfCounterOffsetMS,n=parseInt(t.m_metadata.duration_ms)||0;return Math.max(i,n)}GetRunningTimelineForRecording(e,t){const i=this.m_mapRunningTimelines.get(e);return i&&i.m_runningRecording&&i.m_runningRecording.recording_id===t?i:null}ConvertGlobaOffsetToRecordingAndRelativeOffset(e){if(!this.m_bInitialized)return null;let t=this.FindTimelineAtOffset(e,0);if(!t)return null;let i=t.nTimelineOffsetMS-t.ulGlobalToTimelineOffset;for(let e of t.timeline.metadata.recordings){let n=parseInt(e.start_offset_ms);if(n+parseInt(e.duration_ms)<i||n>i)continue;let a=parseInt(e.recording_zero_timeline_offset_ms),r=Math.max(i-n,0);return isNaN(a)||(r=Math.max(t.nTimelineOffsetMS-a,0)),{strRecordingID:e.recording_id,nRecordingOffsetMS:r,nStartOffsetMS:n}}return null}async FindRecordingAndOffsetForEntry(e){for(const t of this.m_mapRunningTimelines.keys()){if(!this.IsActiveTimeline(t))continue;await this.LoadTimelineData(t);const i=this.m_mapTimelineData.get(t),n=this.m_mapRunningTimelines.get(t);if(i&&n){for(const t of i.m_rgEntries)if(t.id==e){const e=parseInt(t.time);for(const t of n.m_metadata.recordings){const i=parseInt(t.start_offset_ms),n=i+parseInt(t.duration_ms);if(e>=i&&e<=n)return{strRecordingID:t.recording_id,nRecordingOffsetMS:e,nStartOffsetMS:i}}}break}}}GetClosestNextRecordingInGlobalTimeline(e){for(let t of this.m_rgTimelineMetadata)for(let i of t.metadata.recordings){if(parseInt(i.start_offset_ms)+t.nGlobalOffsetMS.valMS>e.valMS)return i}return null}GetClosestPreviousRecordingInGlobalTimeline(e){let t=null;for(let i of this.m_rgTimelineMetadata)for(let n of i.metadata.recordings){if(parseInt(n.start_offset_ms)+i.nGlobalOffsetMS.valMS>e.valMS)return t;t=n}return t}ConvertRecordingTimeMStoPreTrimTimeMS(e,t){for(let i of this.m_rgTimelineMetadata)for(let n of i.metadata.recordings)if(n.recording_id===e){const e=parseInt(n.recording_zero_timeline_offset_ms),a=this.GetTimelineStartBeforeGlobalZeroMS(i.metadata.timeline_id);return!a||isNaN(e)?t:t+a-e}return t}GetTimelineDataOrStartLoad(e){if(!e)return null;let t=this.m_mapTimelineData.get(e);return t||(this.LoadTimelineData(e),t=this.m_mapTimelineData.get(e)),t}GetTimelineData(e){return this.m_mapTimelineData.get(e)}SetTimelineData(e,t){const i=this.ProcessTimelineEntries(t);this.m_mapTimelineData.set(e,i)}GetClosestPreviousEntryInTimeline(e,t){const i=this.GetTimelineMetadata(e),n=this.GetTimelineStartBeforeGlobalZeroMS(e),a=this.GetTimelineDataOrStartLoad(e);let r=null;if(a&&"loaded"===a.m_strState){const e=a.m_rgEntries.filter((e=>{const t=parseInt(e.time);return t<n+parseInt(i.metadata.duration_ms)&&t>n})),m=s.rJ(e,(e=>t.valMS-1-parseInt(e.time)));-1!==m&&(r=e[m])}return{entry:r,timelineState:a?.m_strState}}GetClosestNextEntryInTimeline(e,t){const i=this.GetTimelineMetadata(e),n=this.GetTimelineStartBeforeGlobalZeroMS(e),a=this.GetTimelineDataOrStartLoad(e);let r=null;if(a&&"loaded"===a.m_strState){const e=a.m_rgEntries.filter((e=>{const t=parseInt(e.time);return t<n+parseInt(i.metadata.duration_ms)&&t>n})),m=s.rJ(e,(e=>t.valMS-parseInt(e.time)));m<e.length-1&&(r=e[m+1])}return{entry:r,timelineState:a?.m_strState}}GetClosestPreviousEntryInGlobalTimeline(e){const t=this.GetTimelineOffsetFromGlobal(e,0),i=this.GetTimelineData(t.strTimelineID);if(!i||"loaded"!==i.m_strState)return{timelineID:t?.strTimelineID,timelineState:i?.m_strState,entry:null,globalMS:null};const n=this.GetTimelineStartBeforeGlobalZeroMS(t.strTimelineID),a=t.nTimelineOffsetMS.valMS+n,r=s.rJ(i.m_rgEntries,(e=>a-parseInt(e.time)));if(-1!==r){const e=i.m_rgEntries[r],a=this.GetTimelineMetadata(t.strTimelineID).nGlobalOffsetMS.valMS-n+parseInt(e.time);return a<0?{timelineID:t.strTimelineID,timelineState:i.m_strState,entry:null,globalMS:null}:{timelineID:t.strTimelineID,timelineState:i.m_strState,entry:e,globalMS:(0,u.Sb)(a)}}let m=this.GetTimelineMetadataIndex(t.strTimelineID);if(m<1)return{timelineID:t.strTimelineID,timelineState:i.m_strState,entry:null,globalMS:null};for(let e=m-1;e>=0;e--){const t=this.m_rgTimelineMetadata[e],i=this.GetTimelineData(t.metadata.timeline_id);if(i){if("loaded"!==i.m_strState)return{timelineID:t.metadata.timeline_id,timelineState:i.m_strState,entry:null,globalMS:null};if(i.m_rgEntries.length){const e=i.m_rgEntries[i.m_rgEntries.length-1],n=this.GetTimelineStartBeforeGlobalZeroMS(t.metadata.timeline_id),a=t.nGlobalOffsetMS.valMS-n+parseInt(e.time);return a<0?{timelineID:t.metadata.timeline_id,timelineState:i.m_strState,entry:null,globalMS:null}:{timelineID:t.metadata.timeline_id,timelineState:i.m_strState,entry:e,globalMS:(0,u.Sb)(a)}}}}return{timelineID:this.m_rgTimelineMetadata[0].metadata.timeline_id,timelineState:"loaded",entry:null,globalMS:null}}GetClosestNextEntryInGlobalTimeline(e){const t=this.GetTimelineOffsetFromGlobal(e,0),i=this.GetTimelineData(t.strTimelineID);if(!i||"loaded"!==i.m_strState)return{timelineID:t?.strTimelineID,timelineState:i?.m_strState,entry:null,globalMS:null};const n=this.GetTimelineStartBeforeGlobalZeroMS(t.strTimelineID),a=t.nTimelineOffsetMS.valMS+n,r=s.rJ(i.m_rgEntries,(e=>a-parseInt(e.time)))+1;if(r<=i.m_rgEntries.length-1){const e=i.m_rgEntries[r],a=this.GetTimelineMetadata(t.strTimelineID).nGlobalOffsetMS.valMS-n+parseInt(e.time);return a<this.GetGlobalTimelineEndMS().valMS?{timelineID:t.strTimelineID,timelineState:i.m_strState,entry:e,globalMS:(0,u.Sb)(a)}:{timelineID:t.strTimelineID,timelineState:i.m_strState,entry:null,globalMS:null}}const m=this.m_rgTimelineMetadata.length;let l=this.GetTimelineMetadataIndex(t.strTimelineID);if(-1===l||l===m-1)return{timelineID:t.strTimelineID,timelineState:i.m_strState,entry:null,globalMS:null};for(let e=l+1;e<m;e++){const t=this.m_rgTimelineMetadata[e],i=this.GetTimelineData(t.metadata.timeline_id);if(i){if("loaded"!==i.m_strState)return{timelineID:t.metadata.timeline_id,timelineState:i.m_strState,entry:null,globalMS:null};if(i.m_rgEntries.length){const e=i.m_rgEntries[0],n=this.GetTimelineStartBeforeGlobalZeroMS(t.metadata.timeline_id),a=t.nGlobalOffsetMS.valMS-n+parseInt(e.time);return a<this.GetGlobalTimelineEndMS().valMS?{timelineID:t.metadata.timeline_id,timelineState:i.m_strState,entry:e,globalMS:(0,u.Sb)(a)}:{timelineID:t.metadata.timeline_id,timelineState:i.m_strState,entry:null,globalMS:null}}}}return{timelineID:this.m_rgTimelineMetadata[m-1].metadata.timeline_id,timelineState:"loaded",entry:null,globalMS:null}}FindRangeEventsAtGlobalMS(e){const t=this.GetTimelineOffsetFromGlobal(e,0),i=this.GetTimelineDataOrStartLoad(t.strTimelineID);if(!i||"loaded"!==i.m_strState)return[];const n=[];for(const e of i.m_rgEntries){if(parseInt(e.time)>t.nTimelineOffsetMS.valMS)break;if("event"!==e.type||0==parseInt(e.duration))continue;const i=parseInt(e.time),a=i+parseInt(e.duration);i<=t.nTimelineOffsetMS.valMS&&a>=t.nTimelineOffsetMS.valMS&&n.push(e)}return n}GetStateDescriptionAtGlobalMS(e){const t=this.GetTimelineOffsetFromGlobal(e.valMS,0),i=this.GetTimelineDataOrStartLoad(t.strTimelineID);if(!i||"loaded"!==i.m_strState)return null;const n=s.rJ(i.m_rgStateDescriptions,(e=>t.nTimelineOffsetMS.valMS-parseInt(e.time)));return n>-1?i.m_rgStateDescriptions[n]:null}AdvanceGameModeIndex(e){let t=e.m_iGameModeChanges;for(;t+1<e.m_data.m_rgGameModeChanges.length;){let i=e.m_data.m_rgGameModeChanges[t+1];if(parseInt(i.time)>e.m_nTimelineOffsetMS)break;t++}e.m_iGameModeChanges=t}AdvanceEntriesIndex(e){for(-1==e.m_iEntries&&e.m_iEntries++;e.m_iEntries<e.m_data.m_rgEntries.length;){let t=e.m_data.m_rgEntries[e.m_iEntries];if(parseInt(t.time)>=e.m_nTimelineOffsetMS)break;e.m_iEntries++}}CreateTimelineIterator(e,t){let i=this.FindTimelineAtOffset(e,t);if(!i)return{m_timeline:null,m_data:null,m_nTimelineOffsetMS:0,m_iGameModeChanges:-1,m_iEntries:-1};let n=this.GetTimelineDataOrStartLoad(i.timeline.metadata.timeline_id),a=-1,r=-1;if("loaded"==n?.m_strState){let e=e=>i.ulGlobalToTimelineOffset-parseInt(e.time);a=s.rJ(n.m_rgGameModeChanges,e),r=s.rJ(n.m_rgEntries,e)}let m={m_timeline:i.timeline.metadata,m_data:n,m_nTimelineOffsetMS:Math.max(i.ulGlobalToTimelineOffset,0),m_iGameModeChanges:a,m_iEntries:r};return this.AdvanceEntriesIndex(m),this.AdvanceGameModeIndex(m),m}HasIteratorReachedEnd(e){return!e.m_timeline}AdvanceIterator(e,t){let i=parseInt(e.m_timeline.duration_ms);if(e.m_nTimelineOffsetMS+t<i+this.m_ulFirstTimelineOffsetMS)return e.m_nTimelineOffsetMS+=t,this.AdvanceEntriesIndex(e),void this.AdvanceGameModeIndex(e);let n=this.m_rgTimelineMetadata.findIndex((t=>t.metadata==e.m_timeline));n<0||n==this.m_rgTimelineMetadata.length-1?e.m_timeline=null:(n++,e.m_timeline=this.m_rgTimelineMetadata[n].metadata,e.m_data=this.GetTimelineDataOrStartLoad(e.m_timeline.timeline_id),e.m_nTimelineOffsetMS=0,e.m_iGameModeChanges=0,e.m_iEntries=0)}GetIteratorTimelineState(e){return e.m_data.m_strState}GetIteratorGameMode(e){return e.m_iGameModeChanges<0||e.m_iGameModeChanges>=e.m_data.m_rgGameModeChanges.length?o.il.Playing:e.m_data.m_rgGameModeChanges[e.m_iGameModeChanges].mode}*GetIteratorEntriesWithin(e,t){let i=e.m_data.m_rgEntries;for(let n=e.m_iEntries;n>=0&&n<i.length;n++){let a=i[n];if(parseInt(a.time)>=e.m_nTimelineOffsetMS+t)break;yield a}}*GetIteratorGameModesWithin(e,t){let i=e.m_data.m_rgGameModeChanges;for(let n=e.m_iEntries;n>=0&&n<i.length;n++){let a=i[n];if(parseInt(a.time)>=e.m_nTimelineOffsetMS+t)break;yield a}}GetFirstRecording(){if(!this.m_bInitialized)return"";const e=this.m_rgTimelineMetadata[0];if(!e)return"";const t=e.metadata.recordings[0];return t?t.recording_id:""}GetFirstRecordingOfLastTimelineSession(){if(!this.m_bInitialized)return"";const e=this.m_rgTimelineMetadata[this.m_rgTimelineMetadata.length-1];if(!e)return"";const t=e.metadata.recordings[0];return t?t.recording_id:""}GetNextRecording(e){if(!this.m_bInitialized||!e)return"";let t=!1;for(let i of this.m_rgTimelineMetadata)for(let n of i.metadata.recordings){if(t)return n.recording_id;n.recording_id==e&&(t=!0)}return""}BRecordingHasZeroOffset(e){if(!this.m_bInitialized)return!1;for(let t of this.m_rgTimelineMetadata)for(let i of t.metadata.recordings)if(i.recording_id==e)return!isNaN(parseInt(i.recording_zero_timeline_offset_ms));return!1}GetTimelineDateMS(e,t){if(!this.m_bInitialized)return 0;let i=this.FindTimelineAtOffset(e,t);return i?1e3*i.timeline.metadata.date_recorded+i.nTimelineOffsetMS:0}InsertEntryIntoTimelineSorted(e,t){s.Xr(e.m_rgEntries,t,((e,t)=>parseInt(e.time)-parseInt(t.time)))}AddEventToTimeline(e,t,i,n,a,r,m,s){if(!this.m_bInitialized)return(0,l.ZI)("timeline loader not initialized, unexpected"),!1;const o=this.m_mapTimelineData.get(e);if(!o)return(0,l.ZI)(`failed to find timeline ${e}`),!1;const d=t+this.GetTimelineStartBeforeGlobalZeroMS(e),_={id:n,time:d+"",type:"event",icon:i,title:r,description:m,priority:a,duration:`${s}`,possible_clip:2};return(0,l.tG)(`adding timeline event marker at ${e} at ${d} MS`),this.InsertEntryIntoTimelineSorted(o,_),this.FireEvent("OnInvalidate",e),!0}RemoveTimelineEvent(e,t){if(!this.m_bInitialized)return(0,l.ZI)("timeline loader not initialized, unexpected"),!1;const i=this.m_mapTimelineData.get(e);if(!i)return(0,l.ZI)(`failed to find timeline ${e}`),!1;const n=i.m_rgEntries.findIndex((e=>e.id===t));return n<0?((0,l.ZI)(`failed to find entry by id: ${t}`),!1):(i.m_rgEntries.splice(n,1),this.FireEvent("OnInvalidate",e),!0)}AddUserMarker(e,t,i,n){if(!this.m_bInitialized)return(0,l.ZI)("timeline loader not initialized, unexpected"),!1;const a=this.m_mapTimelineData.get(e);if(!a)return(0,l.ZI)(`failed to find timeline ${e}`),!1;const r=t+this.GetTimelineStartBeforeGlobalZeroMS(e),m={id:n,time:r+"",type:"usermarker",icon:i,title:"",description:"",priority:0};return(0,l.tG)(`adding user marker at ${e} at ${r} MS`),this.InsertEntryIntoTimelineSorted(a,m),this.FireEvent("OnInvalidate",e),!0}UpdateUserMarker(e,t,i){if(!this.m_bInitialized)return(0,l.ZI)("timeline loader not initialized, unexpected"),!1;const n=this.m_mapTimelineData.get(e);if(!n)return(0,l.ZI)(`failed to find timeline ${e}`),!1;const a=n.m_rgEntries.findIndex((e=>e.id===t));if(a<0)return(0,l.ZI)(`failed to find entry by id: ${t}`),!1;const r=n.m_rgEntries[a],m=r.time;return r.icon=i.strIcon,r.time=""+i.nTimelineOffsetMS,r.title=i.name,r.description=i.description,m!=r.time&&(n.m_rgEntries.splice(a,1),this.InsertEntryIntoTimelineSorted(n,r)),this.FireEvent("OnInvalidate",e),!0}RemoveUserMarker(e,t){if(!this.m_bInitialized)return(0,l.ZI)("timeline loader not initialized, unexpected"),!1;const i=this.m_mapTimelineData.get(e);if(!i)return(0,l.ZI)(`failed to find timeline ${e}`),!1;const n=i.m_rgEntries.findIndex((e=>e.id===t));return n<0?((0,l.ZI)(`failed to find entry by id: ${t}`),!1):(i.m_rgEntries.splice(n,1),this.FireEvent("OnInvalidate",e),!0)}AddRunningTimeline(e,t,i){if(this.m_rgTimelineMetadata.find((t=>t.metadata.timeline_id==e)))return;const n={timeline_id:e,game_id:t,date_recorded:i,recordings:[]},a=this.m_rgTimelineMetadata[this.m_rgTimelineMetadata.length-1],r=a?a.nGlobalOffsetMS.valMS+parseInt(a.metadata.duration_ms):0;s.Xr(this.m_rgTimelineMetadata,{nGlobalOffsetMS:(0,u.Sb)(r),metadata:n},((e,t)=>e.metadata.date_recorded-t.metadata.date_recorded)),this.m_mapTimelineData.set(e,{m_strState:"loaded",m_rgGameModeChanges:[],m_rgStateDescriptions:[],m_rgEntries:[],m_rgPhases:[]});let m={m_metadata:n,m_globalStartMS:r,m_perfCounterStart:performance.now(),m_nPerfCounterOffsetMS:1e3*Math.max(0,(0,d._2)()-i),m_runningRecording:null};this.m_mapRunningTimelines.set(e,m),this.m_schUpdateRunning.IsScheduled()||this.m_schUpdateRunning.Schedule(I,this.UpdateRunningTimelines),this.FireEvent("OnInvalidate",e)}UpdateRunningTimelines(){let e;this.m_mapRunningTimelines.forEach((t=>{e=t.m_metadata.timeline_id;let i=performance.now()-t.m_perfCounterStart+t.m_nPerfCounterOffsetMS;i>(parseInt(t.m_metadata.duration_ms)||0)&&(t.m_metadata.duration_ms=i.toString())})),this.m_mapRunningTimelines.size>0&&this.m_schUpdateRunning.Schedule(I,this.UpdateRunningTimelines),this.FireEvent("OnInvalidate",e)}RunningTimelineStopped(e,t){let i=this.m_mapRunningTimelines.get(e);i&&(i.m_metadata.duration_ms=t,this.m_mapRunningTimelines.delete(e),this.FireEvent("OnInvalidate",e))}AddRunningTimelineEntry(e){let t=this.m_mapRunningTimelines.get(e.timeline_id),i=this.m_mapTimelineData.get(e.timeline_id);if(!t||!i)return;let n=(0,o.rU)(e);if(!n)return;(0,o.hT)(n)?s.Xr(i.m_rgGameModeChanges,n,((e,t)=>parseInt(e.time)-parseInt(t.time))):(0,o.Te)(n)?s.Xr(i.m_rgStateDescriptions,n,((e,t)=>parseInt(e.time)-parseInt(t.time))):s.Xr(i.m_rgEntries,n,((e,t)=>parseInt(e.time)-parseInt(t.time)));let a=parseInt(t.m_metadata.duration_ms)||0,r=parseInt(e.time);a<r&&(t.m_metadata.duration_ms=r.toString()),this.FireEvent("OnInvalidate",e.timeline_id)}TimelineDeleted(e){const t=this.m_rgTimelineMetadata.filter((t=>t.metadata.timeline_id!==e)).map((e=>e.metadata));this.UpdateTimelineMetadata(t),this.m_mapTimelineData.delete(e),this.FireEvent("OnInvalidate",e)}RecordingSessionChanged(e){let t=e.session_id,i=e.notification_type;if(1==i){const i=this.m_mapRunningTimelines.get(e.timeline_id);if(!i)return this.FireEvent("OnInvalidateRecording",e.timeline_id,t),void(0,p.w)(!1,"Received recording started message before timeline info");const n={recording_id:t,start_offset_ms:e.start_offset,recording_zero_timeline_offset_ms:e.start_offset,duration_ms:e.duration_ms,recording_type:e.recording_type};i.m_metadata.recordings.push(n),i.m_runningRecording=n}else if(2==i){const i=this.GetRunningTimelineForRecording(e.timeline_id,t);if(!i)return;i.m_runningRecording.duration_ms=e.duration_ms,i.m_runningRecording=null,this.FireEvent("OnInvalidateRecording",e.timeline_id,t)}else if(4==i){const i=this.GetTimelineMetadata(e.timeline_id);if(i){const n=i.metadata.recordings.find((e=>e.recording_id===t));if(n){n.start_offset_ms=e.start_offset,n.duration_ms=e.duration_ms;const t=parseInt(e.start_offset)+parseInt(e.duration_ms);t>(parseInt(i.metadata.duration_ms)||0)&&(i.metadata.duration_ms=t.toString())}}this.GetRunningTimelineForRecording(e.timeline_id,t)||this.FireEvent("OnInvalidateRecording",e.timeline_id,t)}else if(3==i){const i=this.GetTimelineMetadata(e.timeline_id);if(i){const e=i.metadata.recordings.filter((e=>e.recording_id!==t));i.metadata.recordings=e}}this.FireEvent("OnInvalidate",e.timeline_id)}GetGlobalTimelineEndMS(){const e=this.m_rgTimelineMetadata[this.m_rgTimelineMetadata.length-1];if(e){const t=isNaN(parseInt(e.metadata.duration_ms))?0:parseInt(e.metadata.duration_ms);return(0,u.Sb)(e.nGlobalOffsetMS.valMS+t)}return(0,u.Sb)(0)}GetEndOfRecordingsMS(){const e=this.m_rgTimelineMetadata[this.m_rgTimelineMetadata.length-1];if(e){const t=e.metadata.recordings[e.metadata.recordings.length-1];if(t){const i=this.m_mapRunningTimelines.has(e.metadata.timeline_id),n=isNaN(parseInt(t.start_offset_ms))?0:parseInt(t.start_offset_ms),a=isNaN(parseInt(e.metadata.duration_ms))?0:parseInt(e.metadata.duration_ms);let r=0;return i?r=Math.max(0,a-n):isNaN(parseInt(t.duration_ms))||(r=parseInt(t.duration_ms)),(0,u.Sb)(e.nGlobalOffsetMS.valMS+n+r)}}return null}GetTotalRecordingDuration(){let e=0;return this.m_rgTimelineMetadata.forEach((t=>{t.metadata.recordings.forEach((t=>{isNaN(parseInt(t.duration_ms))||(e+=parseInt(t.duration_ms))}))})),e}GetTimelineStartBeforeGlobalZeroMS(e){return e==this.m_rgTimelineMetadata[0].metadata.timeline_id?this.m_ulFirstTimelineOffsetMS:0}async GenerateNamePartsFromTimeline(e,t,i,n){let a,r,m,s,l,d=!1;for(let _ of this.m_rgTimelineMetadata){let f=!1;if(!d){if(_.metadata.timeline_id!=e)continue;f=!0,d=!0}const u=_.metadata.timeline_id==i;await this.LoadTimelineData(_.metadata.timeline_id);const c=this.m_mapTimelineData.get(_.metadata.timeline_id);f&&(s=_.metadata.date_recorded+Math.floor(t/1e3)),u&&(l=_.metadata.date_recorded+Math.floor(n/1e3));for(let e of c.m_rgEntries){const i=parseInt(e.time);if(f&&i<t)continue;if(u&&i>n)continue;if(!(0,o.eJ)(e)&&!(0,o.N$)(e))continue;const r=M(e);(!a||r&&r.rank>a.rank)&&(a=r)}for(let e of c.m_rgStateDescriptions){const t=parseInt(e.time);u&&t>n||(!r||m<t)&&(r=e,m=t)}if(u)break}const _=a?.strTitle??r?.title,f=new g.VS(this.GetGameID()),u=h.Vw.GetAppInfo(f.GetInternalAppID()),c=u?.name;return{strTimelinePart:_,strAppNamePart:c,rtStart:s,rtEnd:l}}async GenerateClipNameFromTimeline(e,t,i,n){const{strTimelinePart:a,strAppNamePart:r}=await this.GenerateNamePartsFromTimeline(e,t,i,n),m=new Date,s=[r,`${m.getFullYear()}-${(m.getMonth()+1).toString().padStart(2,"0")}-${m.getDate().toString().padStart(2,"0")} ${m.toLocaleTimeString()}`,a].filter((e=>!!e)).join(" - ");return(0,l.q_)(`Generated clip name "${s}"`),s}}function M(e){switch(e.type){case"event":const t=e;return{rank:5e4+e.priority,strTitle:t.title};case"usermarker":const i=e;return i.title||i.description?{rank:1e5+e.priority,strTitle:e.title||e.description}:null;case"state_description":return{rank:4e4,strTitle:e.title};case"achievement":return{rank:9e4,strTitle:e.title}}return null}(0,n.Cg)([c.sH],S.prototype,"m_bInitialized",void 0),(0,n.Cg)([f.o],S.prototype,"UpdateRunningTimelines",null)},79098:(e,t,i)=>{i.d(t,{VS:()=>s});var n=i(37976),a=i(28629),r=i(47578),m=i(58156);class s{m_ulGameID;constructor(e,t,i){if("string"==typeof e)this.m_ulGameID=n.A.fromString(e,!0);else{const a=i,r=((255&e)<<24)+(16777215&t);this.m_ulGameID=n.A.fromBits(r,a,!0)}}GetAppID(){return 16777215&this.m_ulGameID.getLowBitsUnsigned()}GetType(){return this.m_ulGameID.getLowBitsUnsigned()>>24&255}GetModID(){return this.m_ulGameID.getHighBitsUnsigned()}ConvertTo64BitString(){return this.m_ulGameID.toString()}BIsSteamApp(){return this.GetType()===a.Rh.k_EGameIDTypeApp}BIsShortcut(){return this.GetType()===a.Rh.k_EGameIDTypeShortcut}BIsMod(){return this.GetType()===a.Rh.k_EGameIDTypeGameMod}BIsP2PFile(){return this.GetType()===a.Rh.k_EGameIDTypeP2P}GetInternalAppID(){return this.BIsSteamApp()?this.GetAppID():this.GetModID()}BIsValid(){switch(this.GetType()){case a.Rh.k_EGameIDTypeApp:return this.GetAppID()!==r.sc;case a.Rh.k_EGameIDTypeGameMod:return this.GetAppID()!==r.sc&&2147483648&this.GetModID();case a.Rh.k_EGameIDTypeShortcut:return 0!=(2147483648&this.GetModID());case a.Rh.k_EGameIDTypeP2P:return this.GetAppID()===r.sc&&2147483648&this.GetModID();default:return(0,m.w)(!1,`Unknown GameID type: ${this.GetType()}`),!1}}static InitFromAppID(e){return new s(a.Rh.k_EGameIDTypeApp,e,0)}static InitFromShortcutID(e){return new s(a.Rh.k_EGameIDTypeShortcut,0,e)}}}}]);